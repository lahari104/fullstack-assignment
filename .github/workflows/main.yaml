---

name: CI/CD Pipeline for Soulpage Frontend and Backend Deployment using Docker

on:
  push:
    branches:
      - docker

jobs:
  build-and-deploy:
    runs-on: soulpage

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Build Docker Image of Frontend and Push it to DockerHub
        run: |
          cd frontend
          docker build -t ${{ github.repository }}-frontend:${{ github.run_number }} .
          docker tag ${{ github.repository }}-frontend:${{ github.run_number }} lahari23/soulpage:${{ github.repository }}-frontend-${{ github.run_number }}
          docker push lahari23/soulpage:${{ github.repository }}-frontend-${{ github.run_number }}

      - name: Build Docker Image of Backend and Push it to DockerHub
        run: |
          cd backend
          docker build -t ${{ github.repository }}-backend:${{ github.run_number }} .
          docker tag ${{ github.repository }}-backend:${{ github.run_number }}
          docker tag ${{ github.repository }}-backend:${{ github.run_number }} lahari23/soulpage:${{ github.repository }}-backend-${{ github.run_number }}
          docker push lahari23/soulpage:${{ github.repository }}-backend-${{ github.run_number }}

      - name: Deploy Frontend container
        run: | 
          docker run -d -P ${{ github.repository }}-frontend:${{ github.run_number }}

      - name: Deploy Backend container
        run: | 
          docker run -d -P ${{ github.repository }}-backend:${{ github.run_number }}

      - name: Deploying the applications using doker compose
        run:
         docker compose up -d
         docker image ls
         docker ps -a